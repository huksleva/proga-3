# **Лабораторная работа №7**  
**Программирование (3 семестр)**  
**Клиент-серверное приложение на Python с использованием HTTPServer и Jinja2**

---

## **1. Цель работы**

Целью лабораторной работы является разработка простого клиент-серверного веб-приложения на языке Python без использования сторонних серверных фреймворков. В ходе выполнения работы были решены следующие задачи:
- Реализованы классы предметной области (`Author`, `App`, `User`, `Currency`, `UserCurrency`) с геттерами и сеттерами, обеспечивающими валидацию типов и корректности значений.
- Создан HTTP-сервер на основе встроенных модулей `http.server.HTTPServer` и `BaseHTTPRequestHandler`.
- Реализована маршрутизация запросов по заданным URL-адресам: `/`, `/users`, `/user?id=...`, `/currencies`, `/author`.
- Применён шаблонизатор Jinja2 для генерации HTML-страниц на основе данных.
- Реализована интеграция с официальным API ЦБ РФ для получения актуальных курсов валют в формате XML.
- Структура проекта организована в соответствии с архитектурой MVC (Model–View–Controller).
- Написаны юнит-тесты для моделей и серверной логики.

---

## **2. Описание предметной области**

Предметная область представляет систему для **отслеживания курсов валют и подписок пользователей**. Основные сущности и их свойства:

- **Author**  
  - `name` — имя автора (строка, не пустая)  
  - `group` — учебная группа (строка, не пустая)  
  - `age` — возраст (целое от 18 до 100)  
  - `sex` — пол (`"М"` или `"Ж"`)

- **App**  
  - `name` — название приложения (строка)  
  - `version` — версия (строка)  
  - `author` — объект класса `Author`

- **User**  
  - `i_d` — уникальный идентификатор (целое положительное число)  
  - `name` — имя пользователя (строка, не пустая)

- **Currency**  
  - `identification_number` — строковый ID из XML (например, `"R01235"`)  
  - `num_code` — цифровой код (целое положительное)  
  - `char_code` — символьный код (например, `"USD"`)  
  - `name` — название валюты  
  - `value` — курс (положительное число)  
  - `nominal` — номинал (целое положительное)

- **UserCurrency**  
  - `id` — ID подписки  
  - `user_id` — ссылка на `User.i_d`  
  - `currency_id` — ссылка на `Currency.identification_number`  
  → реализует связь «много ко многим» между пользователями и валютами.

---

## **3. Структура проекта**

```
ЛР7/
├── myapp.py                   # Точка входа: запуск сервера, маршрутизация
├── __init__.py                # Сделать папку Python-пакетом
├── controllers/               # (опционально, в данной реализации логика в myapp.py)
├── models/
│   ├── __init__.py
│   ├── author.py
│   ├── app.py
│   ├── user.py
│   ├── currency.py
│   └── user_currency.py
├── templates/
│   ├── index.html             # Главная страница
│   ├── users.html             # Список пользователей
│   ├── user_detail.html       # Профиль пользователя
│   ├── currencies.html        # Курсы валют
│   └── author.html            # Информация об авторе
├── static/                    # (не использовалось, но доступно для CSS/JS)
└── utils/
    ├── __init__.py
    └── currencies_api.py      # Функция get_currencies()
```

**Назначение ключевых файлов:**
- `myapp.py` — инициализация сервера, обработка запросов, рендеринг шаблонов.
- `models/*.py` — чистые модели с валидацией через геттеры/сеттеры.
- `templates/*.html` — шаблоны Jinja2 для отображения данных.
- `utils/currencies_api.py` — получение и парсинг XML с сайта ЦБ РФ.

---

## **4. Описание реализации**

### **4.1. Реализация моделей**

Каждая модель реализована как класс с приватными полями (`_field`) и публичными свойствами через `@property` и `@<имя>.setter`. Все сеттеры содержат **строгую валидацию типов, диапазонов и непустоты**.

Пример (`models/currency.py`):
```python
@property
def value(self) -> float:
    return self._value

@value.setter
def value(self, val: float):
    if not isinstance(val, (int, float)) or val <= 0:
        raise ValueError("Курс валюты должен быть положительным числом")
    self._value = float(val)
```

Это обеспечивает целостность данных и соответствует требованиям задания.

---

### **4.2. Маршрутизация и обработка запросов**

Сервер основан на `BaseHTTPRequestHandler`. Маршрутизация реализована через анализ `self.path` и `parse_qs`:

```python
def do_GET(self):
    if self.path == "/":
        self.handle_index()
    elif self.path.startswith("/user"):
        user_id = int(parse_qs(urlparse(self.path).query)["id"][0])
        self.handle_user(user_id)
    # ... другие маршруты
```

Каждый обработчик (`handle_*`) формирует данные и рендерит соответствующий шаблон.

---

### **4.3. Использование шаблонизатора Jinja2**

Объект `Environment` инициализируется **один раз при старте приложения**:

```python
templates_dir = os.path.join(os.path.dirname(__file__), "templates")
env = Environment(
    loader=FileSystemLoader(templates_dir),
    autoescape=select_autoescape()
)
```

Преимущества:
- Шаблоны не перезагружаются при каждом запросе → высокая производительность.
- Автоматическое экранирование HTML → безопасность.
- Возможность многократного рендеринга с разными данными.

Пример рендеринга:
```python
html = template_users.render(users=users, navigation=...)
```

---

### **4.4. Интеграция функции `get_currencies`**

Функция `get_currencies()` в `utils/currencies_api.py`:
- Выполняет GET-запрос к `https://www.cbr.ru/scripts/XML_daily.asp`.
- Парсит XML с помощью `xml.etree.ElementTree`.
- Создаёт список объектов `Currency` с корректными атрибутами.
- Обрабатывает ошибки (сетевые, парсинг) и возвращает пустой список в случае сбоя.

Курсы обновляются **при каждом запросе к `/currencies`**, что гарантирует актуальность данных.

---

## **5. Примеры работы приложения**
![Pasted image 20260101172103.png](images/Pasted%20image%2020260101172103.png)
![Pasted image 20260101172113.png](images/Pasted%20image%2020260101172113.png)
![Pasted image 20260101172121.png](images/Pasted%20image%2020260101172121.png)
![Pasted image 20260101172129.png](images/Pasted%20image%2020260101172129.png)
![Pasted image 20260101172141.png](images/Pasted%20image%2020260101172141.png)
![Pasted image 20260101172159.png](images/Pasted%20image%2020260101172159.png)
![Pasted image 20260101172208.png](images/Pasted%20image%2020260101172208.png)


1. **Главная страница (`/`)** — отображает название приложения, версию, имя автора и группу.
2. **Список пользователей (`/users`)** — таблица с именами и ссылками на профили.
3. **Курсы валют (`/currencies`)** — таблица с актуальными курсами (номинал, название, значение).
4. **Профиль пользователя (`/user?id=1`)** — имя, ID и список подписанных валют с курсами.

> *(Пример вывода: "Доллар США (USD) — 78.267 за 1")*


---

## **8. Выводы**

В ходе выполнения лабораторной работы:
- Были успешно реализованы принципы архитектуры **MVC**: модели не содержат логики отображения, контроллеры не хранят бизнес-правила, а шаблоны — только HTML.
- Освоена работа с **HTTPServer** на низком уровне: обработка GET-запросов, маршрутизация, формирование ответов.
- Получен практический опыт использования **Jinja2** вне фреймворков, включая кэширование и безопасный рендеринг.
- Научился интегрировать внешние **API валют** и преобразовывать XML в объекты Python.

**Основные трудности:**
- Начальные проблемы с настройкой `Jinja2` (ошибки `TemplateNotFound`), решённые переходом на `FileSystemLoader`.
- Проблемы с валидацией `ID` в модели `Currency` (строка vs число), исправленные путём чёткого разделения свойств.
- Ошибки маршрутизации из-за опечаток в именах методов (`do_get` вместо `do_GET`).

Проект продемонстрировал, что даже без фреймворков можно создать структурированное, тестируемое и масштабируемое веб-приложение на Python.

---

